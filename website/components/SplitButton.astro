---
// Copyright (c) 2025 Oscar Pernia
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with this program.  If not, see <https://www.gnu.org/licenses/>.

import PanDownSymbolic from "@/assets/icons/pan-down-symbolic.svg";
import PrimaryButton from "@/components/PrimaryButton.astro";

interface Props {
  class?: string;
  href?: string;
  menuButtonLabel?: string;
  [key: string]: any;
}
const { class: className = "", href, menuButtonLabel, ...props } = Astro.props;
---

<mqtty-split-button
  class:list={["flex", className]}
  data-menu-html={await Astro.slots.render("menu-entries")}
  {...props}
>
  <PrimaryButton
    class="rounded-l-xl border-r border-[#ffffff40] grow"
    href={href}
    data-split-main
  >
    <slot name="primary-btn-content" />
  </PrimaryButton>
  <PrimaryButton
    class="rounded-r-xl"
    aria-haspopup="menu"
    type="button"
    aria-label={menuButtonLabel}
    data-split-toggle
  >
    <PanDownSymbolic fill="white" aria-hidden="true" data-menu-icon />
  </PrimaryButton>
</mqtty-split-button>

<script>
  import "tippy.js/dist/svg-arrow.css";
  import tippy, { roundArrow } from "tippy.js";

  let hiddenRoundArrow = roundArrow.replace(/<\s*svg\b/, "<svg aria-hidden=\"true\"");

  class MQTTySplitButton extends HTMLElement {
    connectedCallback() {
      const toggle = this.querySelector("[data-split-toggle]");
      const menuIcon = this.querySelector("[data-menu-icon]");

      tippy(menuIcon, {
        allowHTML: true,
        content:
          `<ul class="card-box-shadow popover-menu">` +
          this.dataset.menuHtml +
          `</ul>`,
        trigger: "click",
        triggerTarget: toggle,
        interactive: true,
        arrow: hiddenRoundArrow,
        placement: "bottom",
      });
    }
  }

  customElements.define("mqtty-split-button", MQTTySplitButton);
</script>
